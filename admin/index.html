<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f9f9f9; }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#f4f4f4; }
    img { max-width:80px; border-radius:6px; }
    input, textarea { width:100%; margin-bottom:0.5rem; padding:0.5rem; border:1px solid #ccc; border-radius:4px; }
    button { padding:0.5rem 1rem; margin-top:0.5rem; border:none; border-radius:4px; cursor:pointer; }
    #createPageSection { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:2rem; }
    #createPageSection h3 { margin-top:0; }
    .status-online { color: green; font-weight: bold; }
    .status-offline { color: red; font-weight: bold; }
  </style>
</head>
<body>

<div id="auth-section">
  <h2>Admin Login</h2>
  <button id="googleLogin">Login with Google</button>
  <div style="margin-top:20px;">
    <input id="phoneInput" placeholder="Enter phone" />
    <button id="sendCode">Send Code</button>
  </div>
  <div id="codeSection" class="hidden">
    <input id="verifyCode" placeholder="Enter code" />
    <button id="verifyBtn">Verify</button>
  </div>
  <div id="recaptcha-container"></div>
</div>

<div id="admin-panel" class="hidden">
  <h2>Dashboard</h2>
  <button id="logoutBtn" class="hidden">Logout</button>

  <section id="createPageSection">
    <h3>Create New Page</h3>
    <input id="title" placeholder="Page Title" />
    <textarea id="description" placeholder="Page Description"></textarea>
    <input id="keywords" placeholder="Comma separated keywords" />
    <input id="imageUrl" placeholder="Page Image URL" />
    <input id="domain" placeholder="Page Domain (example.com)" />
    <button id="createBtn">Create Page</button>
  </section>

  <div id="dashboardContent"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { 
  getAuth, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, 
  signInWithPhoneNumber, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { 
  getFirestore, collection, getDoc, doc, updateDoc, arrayUnion, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
  authDomain: "contentmanagement-8af61.firebaseapp.com",
  projectId: "contentmanagement-8af61",
  storageBucket: "contentmanagement-8af61.firebasestorage.app",
  messagingSenderId: "579537581112",
  appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
  measurementId: "G-ZPWGF7YMPE"
};

// Initialize
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser;

// Whitelists
const allowedEmails = ["1988lrp@gmail.com"];
const allowedPhones = ["+19725977878", "+12145527280", "+19725977878", "+12145527280"];

// Auth State
onAuthStateChanged(auth, async (user) => {
  if (user && (allowedEmails.includes(user.email) || allowedPhones.includes(user.phoneNumber))) {
    currentUser = user;
    await showAdminPanel(user);
  } else if (user) {
    alert("Unauthorized");
    logoutUser();
  }
});

// Logout
function logoutUser() {
  signOut(auth);
  currentUser = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
}
document.getElementById("logoutBtn").addEventListener("click", logoutUser);

// Google Login
document.getElementById("googleLogin").addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    if (!allowedEmails.includes(user.email)) {
      alert("Unauthorized email.");
      logoutUser();
    } else {
      currentUser = user;
      await showAdminPanel(user);
    }
  } catch (error) { alert(error.message); }
});

// Phone Login
let recaptchaVerifier;
document.addEventListener("DOMContentLoaded", () => {
  recaptchaVerifier = new RecaptchaVerifier("recaptcha-container", { size: "invisible" }, auth);
  recaptchaVerifier.render();
});

document.getElementById("sendCode").addEventListener("click", async () => {
  let phone = document.getElementById("phoneInput").value.trim();
  if (!phone.startsWith("+")) phone = "+1" + phone;
  if (!allowedPhones.includes(phone)) return alert("Unauthorized phone number.");

  try {
    const confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("codeSection").classList.remove("hidden");
  } catch (error) { alert("Error sending code: " + error.message); }
});

document.getElementById("verifyBtn").addEventListener("click", async () => {
  const code = document.getElementById("verifyCode").value.trim();
  try {
    const result = await window.confirmationResult.confirm(code);
    const user = result.user;
    if (!allowedPhones.includes(user.phoneNumber)) {
      alert("Unauthorized phone number.");
      logoutUser();
    } else {
      currentUser = user;
      await showAdminPanel(user);
    }
  } catch (error) { alert("Invalid code or expired session."); }
});

// Show Dashboard
async function showAdminPanel(user) {
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) {
    document.getElementById("dashboardContent").innerHTML = "<p>No user record found.</p>";
    return;
  }

  const userData = userSnap.data();
  if (!userData.loginTypes || !userData.loginTypes.includes("login")) {
    document.getElementById("dashboardContent").innerHTML = "<p>You are not authorized for dashboard access.</p>";
    return;
  }

  await loadDashboard(true);
}

// Ping function
async function pingSite(domain) {
  let url = domain.startsWith("http") ? domain : "https://" + domain;
  try {
    const resp = await fetch(url, { method: "HEAD", cache: "no-store" });
    return resp.ok;
  } catch { return false; }
}

// Create Page
document.getElementById("createBtn").addEventListener("click", async () => {
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const keywords = document.getElementById("keywords").value.split(",").map(k => k.trim());
  const image = document.getElementById("imageUrl").value.trim();
  const domain = document.getElementById("domain").value.trim();

  if (!title || !domain) return alert("Title and domain required.");
  if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(domain)) return alert("Invalid domain format.");
  if (image && !/^https?:\/\//.test(image)) return alert("Image URL must start with http/https.");

  const docRef = await addDoc(collection(db,"content"), {
    siteId: "", type: "page", title, description, keywords, image, domain,
    createdBy: currentUser.uid, updatedBy: currentUser.uid,
    status: "draft", analytics: { views:0, uniqueViews:0 },
    createdAt: serverTimestamp(), updatedAt: serverTimestamp()
  });

  await updateDoc(doc(db,"content",docRef.id), { siteId: docRef.id });
  await updateDoc(doc(db, "users", currentUser.uid), {
    createdPages: arrayUnion({ id: docRef.id, title, image, domain, status:"draft", analytics:{views:0} })
  });

  await loadDashboard(true);
});

// Load Dashboard with Live Status
async function loadDashboard(autoPing=false) {
  const contentDiv = document.getElementById("dashboardContent");
  const snapshot = await getDoc(doc(db,"users",currentUser.uid));
  const pages = snapshot.exists() ? snapshot.data().createdPages || [] : [];

  if (pages.length === 0) { contentDiv.innerHTML = "<p>No pages yet.</p>"; return; }

  let html = `<table>
    <thead>
      <tr><th>Preview</th><th>Domain</th><th>Status</th><th>Views</th><th>Actions</th></tr>
    </thead><tbody>`;

  pages.forEach(p => {
    html += `<tr>
      <td><img src="${p.image||''}" alt="preview"></td>
      <td>${p.domain}</td>
      <td id="status-${p.id}" class="status-offline">❌ Offline</td>
      <td>${p.analytics?.views||0}</td>
      <td><button onclick="window.location.href='/admin/editor?id=${p.id}'">Edit</button></td>
    </tr>`;
  });

  html += "</tbody></table>";
  contentDiv.innerHTML = html;

  // Start pinging for live status if enabled
  if (autoPing) {
    pages.forEach(p => updateLiveStatus(p.id, p.domain));
  }
}

// Update Live Status for a Page
async function updateLiveStatus(pageId, domain) {
  const statusEl = document.getElementById(`status-${pageId}`);
  if (!statusEl) return;
  const online = await pingSite(domain);
  statusEl.textContent = online ? "✅ Online" : "❌ Offline";
  statusEl.className = online ? "status-online" : "status-offline";

  // Repeat every 10 seconds
  setTimeout(() => updateLiveStatus(pageId, domain), 10000);
}

</script>
</body>
</html>
